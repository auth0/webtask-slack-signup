var logo_url = 'data:image/png;base64,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';

Function.prototype.stringify = function () { 
    var match = this.toString().match(/[^]*\/\*([^]*)\*\/\s*\}$/);
    return match ? match[1] : ''; 
}

module.exports = function (ctx, req, res) {
    // Validate webtask parameters

    var required_params = ['SLACK_ORG', 'SLACK_TOKEN'];
    for (var i = 0; i < required_params.length; i++) {
        if (typeof ctx.secrets[required_params[i]] !== 'string')
            return handle_error({ 
                code: 400, 
                message: 'You must specify the `' + required_params[i] 
                    + '` parameter when creating the webtask using `wt create --secret ' 
                    + required_params[i] + '={value}` argument.'
            });
    }

    // Configure routing

    if (req.method === 'GET')
        return handle_get_invite();
    else if (req.method === 'POST') {
        if (typeof req.body.email !== 'string' || !req.body.email.trim().match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i))
            return handle_error({ code: 400, message: 'Missing or invalid e-mail address.'});
        else
            return handle_send_invite();
    }
    else 
        return handle_error({ code: 405 });

    function handle_error(error) {
        res.writeHead(200, { 'Content-Type': 'text/html' });
        return res.end(require('ejs').render(oops.stringify(), { logo_url: logo_url, ctx: ctx, error: error }));
    }

    function handle_get_invite() {
        res.writeHead(200, { 'Content-Type': 'text/html' });
        return res.end(require('ejs').render(slack_invite.stringify(), { logo_url: logo_url, ctx: ctx }));
    }

    function handle_send_invite() {
        require('superagent')
            .post('https://' + ctx.secrets.SLACK_ORG + '.slack.com/api/users.admin.invite')
            .type('form')
            .send({
                email: req.body.email.trim(),
                token: ctx.secrets.SLACK_TOKEN,
                set_active: true
            })
            .end(function (error, sres) {
                if (error) 
                    return handle_error({ code: 502, message: error.toString() });
                if (sres.status !== 200) 
                    return handle_error({ code: 502, message: 'Invalid response from Slack: ' + sres.status });
                if (!sres.body.ok) {
                    if (sres.body.error === 'missing_scope' && sres.body.needed === 'admin')
                        return handle_error({ code: 400, message: 'The Slack token is missing `admin` scope required to invite users via Slack API. Use a token from Slack admin account.'})
                    else if (sres.body.error === 'already_invited')
                        return handle_error({ code: 400, message: 'You have been previously invited to this Slack team. Search for email from feedback@slack.com.' });
                    else if (sres.body.error === 'already_in_team')
                        return handle_error({ code: 400, message: 'You are already a member of this Slack team.'})
                    else 
                        return handle_error({ code: 502, message: 'Response from Slack: ' + sres.body.error });
                }

                res.writeHead(200, { 'Content-Type': 'text/html' });
                return res.end(require('ejs').render(invite_sent.stringify(), { logo_url: logo_url, ctx: ctx }));
            });
    }

}

function slack_invite() {/*
<html>
<head>
    <title><%= ctx.secrets.SLACK_ORG %> signup</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <style>

        body {
            font-family: "Avenir Next",Avenir,"Helvetica Neue",Hevetica,sans-serif;
        }

        .header-image {
            position: relative;
            height: 235px;
            width: 100%;
            overflow: hidden;
            margin-bottom: 70px;
        }

        .header-image .image{
            background: transparent url("<%- ctx.secrets.BG_URL || ctx.secrets.LOGO_URL || logo_url %>") center center no-repeat;
            background-size: cover;
            -webkit-filter: blur(12px);
            -moz-filter: blur(12px);
            -o-filter: blur(12px);
            -ms-filter: blur(12px);
            filter: blur(12px);
            position: absolute;
            top: -20px;
            right: -20px;
            bottom: -20px;
            left: -20px;
            opacity: 0.9;
        }

        .user-logo {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            box-shadow: 0px 2px 4px 0px #D0D2D3;
            position: absolute;
            top: 212px;
            left: 49.5%;
        }

        .slack-logo {
            width: 115px;
            height: 115px;
            border-radius: 50%;
            box-shadow: 0px 2px 4px 0px #D0D2D3;
            position: absolute;
            top: 180px;
            right: 48.5%;
        }

        p {
            font-size: 20px;
            margin: 15px 0 0; 
        }

        .input-email {
            max-width: 325px;
            margin: 40px auto;
        }

        .button-invitation {
            background: #E76D5F;
            border-radius: 25px;
            font-size: 16px;
            height: 50px;
            border: none;
            color: white;
            padding: 0 30px;
        }

        .button-invitation:hover {
            background: #DD6557;
        }

        .footer {
            position: relative;
            overflow: hidden;
            margin: 40px 0;
        }

        .separator-line {
            height: 1px;
            width: 100%;
            border-top: 1px solid #E76D5F;
            position: absolute;
            top: 50%;
            left: 0;
        }


        .footer-copy {
            background: white;
        }

        .webtask-copy a {
            color: #333;
        }

        .webtask-copy a:hover {
            text-decoration: none
        }

        .create-copy {
            font-size: 16px;
        }
        
        .create-copy a {
            color: #E76D5F;
        }

        .create-copy a:hover {
            color: #DD6557;
        }

    
    </style>

</head>
<body>
    <header>
        <div class="header-image">
            <div class="image"></div>
        </div>
        <img src="https://cdn.auth0.com/website/webtask/assets/slack-webtask-logo.png" alt="Slack" class="slack-logo">
        <img class="user-logo" src="<%- ctx.secrets.LOGO_URL || logo_url %>" width="100" heigth="100">
    </header>
    <div class="container">
        <div class=" col-md-6 col-md-offset-3 text-center">
            <h2>Join <span><%= ctx.secrets.SLACK_ORG %></span> on Slack</h2>
            <p>Enter your e-mail below to receive an invitation:</p>
            <form method="POST">
              <div class="form-group">
                <input type="email" class="form-control input-email" name="email" placeholder="foo@example.com" required>
              </div>
              <button type="submit" class="button-invitation">Get invitation</button>
            </form>
        </div>
        
    </div>
    <div class="footer">
        <div class="separator-line"></div>
        <div class="col-md-4 col-md-offset-4 text-center footer-copy">
            <p class="webtask-copy">Powered by &nbsp;<a href="https://webtask.io"><img src="https://webtask.io/images/symbol.svg" alt="Webtasks" width="30px" height="30px">&nbsp; Auth0 Webtasks</a></p>
            <p class="create-copy">Create your own  <a href="https://github.com/auth0/webtask-slack-signup">Slack invite</a></p>
        </div>
    </div>
</body>
</html>
*/}

function invite_sent() {/*
<html>
<head>
    <title><%= ctx.secrets.SLACK_ORG %> signup</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
</head>
<body style="padding-top: 30px;">
    <div class="container">
        <div class="jumbotron col-md-6 col-md-offset-3 text-center">
            <img src="<%- ctx.secrets.LOGO_URL || logo_url %>" width="100" heigth="100">
            <h2>Invite to <strong><%= ctx.secrets.SLACK_ORG %></strong> is on its way!</h2>
            <p><small>Check for e-mail from feedback@slack.com</small></p>
        </div>
        <div class="row">
            <div class="col-md-6 col-md-offset-3 text-center">
                <p>Powered by <a href="https://webtask.io">Auth0 Webtasks</a>&nbsp;|&nbsp;Create <a href="https://tomasz.janczuk.org/2016/02/create-slack-signup-page-with-webtasks.html">your own Slack invite</a></p>
            </div>
        </div>
    </div>
</body>
</html>
*/}

function oops() {/*
<html>
<head>
    <title><%= ctx.secrets.SLACK_ORG %> signup</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
</head>
<body style="padding-top: 30px;">
    <div class="container">
        <div class="jumbotron col-md-6 col-md-offset-3 text-center">
            <img src="<%- ctx.secrets.LOGO_URL || logo_url %>" width="100" heigth="100">
            <h2>Something is not quite right...</h2>
            <p><%= error.message %></p>
        </div>
        <div class="row">
            <div class="col-md-6 col-md-offset-3 text-center">
                <p>Powered by <a href="https://webtask.io">Auth0 Webtasks</a>&nbsp;|&nbsp;Create <a href="https://tomasz.janczuk.org/2016/02/create-slack-signup-page-with-webtasks.html">your own Slack invite</a></p>
            </div>
        </div>
    </div>
</body>
</html>
*/}
